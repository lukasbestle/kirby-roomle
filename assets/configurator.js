var g=(e,t,s)=>new Promise((r,i)=>{var o=a=>{try{c(s.next(a))}catch(l){i(l)}},n=a=>{try{c(s.throw(a))}catch(l){i(l)}},c=a=>a.done?r(a.value):Promise.resolve(a.value).then(o,n);c((s=s.apply(e,t)).next())});var O=class{constructor(t,s,r,i){this._outgoingMessageBus=null,this._execMessage=null,this._side=t,this._incomingMessageBus=s,this._outgoingMessageBus=r,this._execMessage=i,this._incomingMessageBus.addEventListener("message",this._handleMessage.bind(this))}setOutgoingMessageBus(t){this._outgoingMessageBus=t}setMessageExecution(t){this._execMessage=t}sendMessage(t,s=[]){return new Promise((r,i)=>{let o=new MessageChannel;o.port1.onmessage=c=>{if(!c||!c.data)return o.port1.close(),o.port2.close(),i(new Error(this._side+" received message but response can not be interpreted"));let a;try{a=JSON.parse(c.data)}catch(l){return o.port1.close(),o.port2.close(),this._prepareError(l),i(l)}a.error?i(a.error):a.result!==void 0?r(a.result):r(),o.port1.close(),o.port2.close()};let n="";try{n=JSON.stringify({message:t,args:s})}catch(c){return i(new Error(this._side+": can not create command because it is not JSON.stringify able"))}if(!this._outgoingMessageBus)return i(new Error(this._side+": outgoing bus not set yet"));this._outgoingMessageBus.postMessage(n,"*",[o.port2])})}_handleMessage(t){let s=t.ports&&Array.isArray(t.ports)&&t.ports.length>0?t.ports[0]:null;if(t.data&&s)try{let r=JSON.parse(t.data);if(!this._execMessage)return s.postMessage(JSON.stringify({error:this._side+" is not ready to handle messages"}));Array.isArray(r.args)||(r.args=[r.args]);let i=this._execMessage(r,t);if(i===void 0)return;i.then((o={})=>{let n,c;typeof o=="object"&&o!==null&&(n=o.error,c=o.result),n?s.postMessage(JSON.stringify({error:n})):c!==void 0?s.postMessage(JSON.stringify({result:c})):s.postMessage(JSON.stringify({result:o}))},o=>{s.postMessage(JSON.stringify({error:this._prepareError(o)}))})}catch(r){s.postMessage(JSON.stringify({error:this._prepareError(r)}))}}_prepareError(t){if(typeof t=="string"){let s=this._side+": "+t;return console.error(s),s}return t.message=this._side+": "+t.message,console.error(t),t.message}},I=".",E={REQUEST_BOOT:"requestBoot",SETUP:"setup",WEBSITE_READY:"websiteReady"},U=(e,t)=>g(void 0,null,function*(){if(typeof e!="string")throw new Error('Configurator ID is not a string type: "'+typeof e+'"');let s=t.customApiUrl?t.customApiUrl:"https://api.roomle.com/v2",r=t.overrideTenant||9,i=s+"/configurators/"+e,o="roomle_portal_v2",n="03-"+window.btoa(new Date().toISOString()+";anonymous;"+o),c=()=>{let d={apiKey:o,currentTenant:r,locale:"en",language:"en",device:1,token:n,platform:"web"};return new Headers(d)},a=new Request(i,{method:"GET",headers:c(),mode:"cors",cache:"default"}),l=yield fetch(a),{configurator:f}=yield l.json();return f}),C=()=>{try{return window.self!==window.top}catch(e){return!0}},D=["127.0.0.1","localhost","0.0.0.0"],H=()=>{let e=C(),t=window.location.href;if(e){if(!document.referrer)return null;t=document.referrer}let{hostname:s}=new URL(t);return s},k=e=>!!(D.includes(e)||e.endsWith("roomle.com")||e.endsWith("gitlab.io")||e.endsWith("gitlab.com")),F=(e,t)=>{let s=JSON.parse(JSON.stringify(e));return S(s,t)},S=(e,t)=>{for(let s in t)try{t[s].constructor===Object?e[s]=S(e[s],t[s]):e[s]=t[s]}catch(r){e[s]=t[s]}return e},A=["language","browserLanguage","userLanguage","systemLanguage"],B=(e=null)=>{let t=window.navigator;if(e)return e.substr(0,2);if(Array.isArray(t.languages)&&t.languages.length>0)return t.languages[0].substr(0,2);for(let s=0,r=A.length;s<r;s++){let i=t[A[s]];if(i)return i.substr(0,2)}return"en"},x="(idle)",W=e=>(y(e),e!=null&&e.customApiUrl&&(e.customApiUrl=decodeURIComponent(e.customApiUrl)),e.shareUrl&&(e.deeplink=e.shareUrl.replace(J,V)),e),y=e=>{if(!e)return;let t=Object.keys(e);for(let s of t){let r=e[s];if(!Array.isArray(r)&&typeof r=="object"&&r!==null)return y(r);if(Array.isArray(r)){for(let i of r)y(i);return}(r==="true"||r==="false")&&(e[s]=r==="true")}},q=(e,t)=>{t.configuratorId=e.id;let s=e.settings||{};return!t.overrideTenant&&e.tenant&&(t.overrideTenant=e.tenant),F(s,t)},G=()=>{let e={};e.locale||(e.locale=B()),e.id===x&&delete e.id;let t=H();return t&&k(t)&&(e.configuratorId="demoConfigurator"),e.customApiUrl="https://www.roomle.com/api/v2",e.emails=!1,e},J="<CONF_ID>",V="#CONFIGURATIONID#",R=()=>/(android)/i.test(navigator.userAgent),T=(e,t,s)=>{let r=null;Object.defineProperty(e,t,{get(){return r||s},set(i){i!=null&&i.mute?r=i.value:(console.warn("You override Roomle defined behaviour. To disalbe this warning pass in an object with the following properties"),console.warn("{ mute: true, value: () => void }"),r=i)}})},N=()=>window.innerHeight*.01+"px",L=e=>{!e||setTimeout(()=>e.style.setProperty(b,N()),0)},v="rml-styles",$=450,b="--rml-full-height",u={CONTAINER:"rml-container",FILL:"rml-fill",POSITION:"rml-pos",TRANSITION:"rml-transition",ANDROID_HEIGHT:"rml-android-height",OVERFLOW_HIDDEN:"rml-overflow-hidden"},w=new Map,_=class{constructor(t,s,r,i){if(this.ui={callbacks:null},this.extended={callbacks:null},this.analytics={callbacks:{}},this.global={callbacks:{}},this._initData={},!t||typeof t.id!="string")throw new Error("Please provide a correct configuratorId, you get the correct ID from your Roomle Contact Person");if(w.has(s))throw new Error("There is already an instance on this DOM element");if(!!!document.getElementById(v)){let c=r.zIndex||9999999,a=document.createElement("style");a.type="text/css",a.id=v;let l="transition:all ease-in-out "+$+"ms;",f=["-webkit-","-o-"].reduce((m,h)=>m+=h+l,"")+l,d=N();a.innerHTML=`
        .${u.CONTAINER}{${b}:${d};}
        .${u.POSITION}{position:fixed;top:0;left:0;z-index:${c};opacity:0}
        .${u.TRANSITION}{${f}}
        .${u.FILL}{width:100%;height:100%;opacity:1}
        .${u.ANDROID_HEIGHT}{height:calc(var(${b},1vh)*100)}
        .${u.OVERFLOW_HIDDEN}{overflow:hidden}
      `,document.head.appendChild(a)}this._onResize=this._onResize.bind(this),R()&&window.addEventListener("resize",this._onResize),this._container=s,this._initData=r,this._configuratorSettings=t;let n=this._createIframe();this._onUseFullPage=this._onUseFullPage.bind(this),this._executeMessage=this._executeMessage.bind(this),this._onBackToWebsite=this._onBackToWebsite.bind(this),this._messageHandler=new O("website",window,null,this._executeMessage),this._waitForIframe=i,this._container.appendChild(n),this._iframe=n,w.set(s,!0)}static createPlanner(t,s,r){return this._create(t,s,r)}static createConfigurator(t,s,r){return this._create(t,s,r)}static create(t,s,r){return this._create(t,s,r)}static createViewer(t,s,r){return this._create(t,s,r)}static _create(t,s,r){return new Promise((i,o)=>g(this,null,function*(){try{let n=S(G(),W(r));n.featureFlags||(n.featureFlags={}),typeof n.featureFlags.realPartList!="boolean"&&(n.featureFlags.realPartList=!0),typeof n.featureFlags.globalCallbacks!="boolean"&&(n.featureFlags.globalCallbacks=!0);let c=yield U(t,n);return r=q(c,n),new this(c,s,r,i)}catch(n){return o(n)}}))}teardown(){this._container&&w.delete(this._container);let t=this._container.querySelector("iframe");t&&this._container.removeChild(t),window.removeEventListener("resize",this._onResize)}_createIframe(){var t;let s=document.createElement("iframe"),r=((t=this._configuratorSettings)===null||t===void 0?void 0:t.url)||"https://www.roomle.com/t/cp/";return this._initData.useLocalRoomle&&(r=location.href.replace("embedding.html","")),location.href.includes("roomle.gitlab.io")&&(r=location.href.replace("embedding.html","index.html")),this._initData.overrideServerUrl&&(r=this._initData.overrideServerUrl),s.src=r,s.classList.add(u.CONTAINER),s.classList.add(u.FILL),s}_onResize(){L(this._iframe)}_onUseFullPage(){this._iframe.classList.add(u.POSITION),document.documentElement.classList.add(u.OVERFLOW_HIDDEN),window.document.body.classList.add(u.OVERFLOW_HIDDEN),R()&&(L(this._iframe),this._iframe.classList.add(u.ANDROID_HEIGHT))}_onBackToWebsite(){this._iframe.classList.remove(u.POSITION),this._iframe.classList.remove(u.ANDROID_HEIGHT),document.documentElement.classList.remove(u.OVERFLOW_HIDDEN),window.document.body.classList.remove(u.OVERFLOW_HIDDEN)}_executeMessage({message:t,args:s},r){var i;if(!r.source||r.source!==((i=this._iframe)===null||i===void 0?void 0:i.contentWindow))return;if(t===E.REQUEST_BOOT)return this._messageHandler.setOutgoingMessageBus(r.source),Promise.resolve({result:this._initData});if(t===E.SETUP){let{methods:l,callbacks:f}=s[0];return l.forEach(d=>{let m=d.split(I),h=m[0],p=m[1];this[h]||(this[h]={}),this[h][p]=function(){return this._messageHandler.sendMessage(d,[...arguments])}.bind(this)}),f.forEach(d=>{let m=d.split(I),h=m[0],p=m[1],P=m[2];this[h]||(this[h]={}),this[h][p]||(this[h][p]={}),this[h][p][P]=()=>{}}),T(this.ui.callbacks,"onUseFullPage",this._onUseFullPage),T(this.ui.callbacks,"onBackToWebsite",this._onBackToWebsite),this._waitForIframe(this),setTimeout(()=>this._messageHandler.sendMessage(E.WEBSITE_READY),0),Promise.resolve({result:null})}let o=t.split(I),n=o[0],c=o[1],a=o.length===3?o[2]:null;if(a&&this[n][c][a]){let l=this[n][c][a](...s);return l instanceof Promise?l.then(f=>({result:f})):l!==void 0?Promise.resolve({result:l}):Promise.resolve({result:null})}return Promise.reject('Message "'+t+'" is unkown')}};var M=class{constructor(e){this.props=e,this.variantSelector="#"+e.htmlId+" .roomle-configurator-variants input",this.currentId=this.idFromUrl()||e.options.id}init(){return g(this,null,function*(){if(this.configurator)return;document.querySelectorAll(this.variantSelector).forEach(s=>{s.addEventListener("change",this.onVariantSelect.bind(this))}),window.addEventListener("popstate",this.onUrlChange.bind(this)),this.updateVariants(this.currentId);let e=this.props.options;e.id=this.currentId,e.deeplink=this.idToUrl(this.props.htmlId+"-PLACEHOLDER",!0).href.replace(this.props.htmlId+"-PLACEHOLDER","#CONFIGURATIONID#");let t=e.moc===!0?"createPlanner":"createConfigurator";this.configurator=yield _[t](this.props.configuratorId,document.getElementById(this.props.htmlId+"-container"),e),this.currentId!==e.id&&this.load(this.currentId),this.props.targetUrl&&(this.configurator.ui.callbacks.onRequestPlan=this.onRequestPlan.bind(this),this.configurator.ui.callbacks.onRequestProduct=this.onRequestProduct.bind(this))})}configurationToObject(e,t,s){return{catalog:e.catalog,configuratorUrl:this.idToUrl(s,!0),depth:e.depth,height:e.height,id:s,label:e.label,parts:t.fullList,perspectiveImage:e.perspectiveImage,rootComponentId:e.rootComponentId,topImage:e.topImage,width:e.width}}idFromUrl(){return new URLSearchParams(window.location.search).get(this.props.htmlId)}idToUrl(e,t=!1){let s=new URL(window.location.href);return s.searchParams.set(this.props.htmlId,e),t===!0&&(s.hash=this.props.htmlId),s}load(e){return g(this,null,function*(){return this.currentId=e,this.updateVariants(e),this.configurator?(yield this.configurator.ui.loadObject(e),!0):!1})}onRequestPlan(e,t,s){s=s.map(r=>this.configurationToObject(r.data,r.parts,r.configurationHash)),this.submit({configuratorUrl:this.idToUrl(e,!0),id:e,items:s,thumbnail:"https://uploads.roomle.com/plans/"+e+"/thumbnail.png"})}onRequestProduct(e,t,s,r,i,o){o=this.configurationToObject(o,s,e),this.submit({configuratorUrl:this.idToUrl(e,!0),id:null,items:[o],thumbnail:o.perspectiveImage})}onUrlChange(){let e=this.idFromUrl();e?this.load(e):this.load(this.props.options.id)}onVariantSelect(e){let t=this.idToUrl(e.target.value);window.history.pushState(null,"",t),this.load(e.target.value)}submit(e){let t=document.createElement("form");t.action=this.props.targetUrl,t.method="POST",t.style.display="none";let s=document.createElement("input");s.name="roomle-configuration",s.value=JSON.stringify(e),t.appendChild(s),document.body.appendChild(t),t.submit()}updateVariants(e){let t=document.querySelector(this.variantSelector+"[checked]"),s=document.querySelector(this.variantSelector+'[value="'+CSS.escape(e)+'"]');t&&(t.removeAttribute("checked"),t.checked=!1),s&&(s.checked=!0,s.setAttribute("checked","true"))}};export{M as default};
/**
 * Configurator
 *
 * @package   Kirby Roomle Plugin
 * @author    Lukas Bestle <project-kirbyroomle@lukasbestle.com>
 * @link      https://github.com/lukasbestle/kirby-roomle
 * @copyright Lukas Bestle
 * @license   https://opensource.org/licenses/MIT
 */
